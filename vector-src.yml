api: {enabled: true}
sources:
  logs:
    type: nats
    url: "nats://[fdaa::3]:4223"
    subject: 'logs.>'
    auth: {strategy: user_password, user_password: {user: "${ORG-personal}", password: "${ACCESS_TOKEN?}"}}
    connection_name: Fly logs stream
    decoding:
      codec: vrl
      vrl:
        source: |
          . = parse_json!(.message)
          . = merge!(., parse_json(.message) ?? {})

  metrics_in:
    type: nats
    url: "nats://[fdaa::3]:4223"
    subject: 'metrics.>'
    auth: {strategy: user_password, user_password: {user: "${ORG-personal}", password: "${ACCESS_TOKEN?}"}}
    connection_name: Fly metrics stream
    decoding:
      codec: vrl
      vrl:
        source: |
          . = parse_json!(.message)
          .timestamp = parse_timestamp!(.timestamp, "%+")

transforms:
  metrics:
    type: log_to_metric
    inputs: [metrics_in]
    all_metrics: true
    metrics: []

sinks:
  logs_out:
    type: vector
    inputs: [logs]
    compression: true
    address: "data.process.${FLY_APP_NAME}.internal:6000"
    buffer: {type: disk, max_size: 268435488}
  metrics_out:
    type: vector
    inputs: [metrics]
    compression: true
    address: "data.process.${FLY_APP_NAME}.internal:6001"
    buffer: {type: disk, max_size: 268435488}
